{% extends "main\\base.html" %}
{% load static %}
{% load custom_filters %}

{% block head-title %}
    <title>Saved texts</title>
{% endblock %}

{% block head-static %}
<script type="text/javascript" src="{% static 'js/main/saved_table.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/main/saved_table.css' %}">
{% endblock %}


{% block body %}
<div class="container-fluid" style="padding: 7px">
<div class="row" style="padding: 25px; border-radius: 25px; background-color: #ffffff; margin: 6px">
    <div class="col-12" style="background-color: #ffffff ; padding: 20px; padding-bottom: 10px; border-radius: 25px;">
        <table class="table table-responsive table-hover">
            <thead>
            <tr>
                <th scope="col" class="table-head">کد ذخیره</th>
                <th scope="col" class="table-head">متن ورودی</th>
                <th scope="col" class="table-head">ترجمه</th>
                <th scope="col" class="table-head">تاریخ ذخیره‌سازی</th>
                <th scope="col" class="table-head">گزینه‌ها</th>
            </tr>
            </thead>
            <tbody>
            {% for saved_task in page_objects %}
            <tr class="clickable parent-task" aria-expanded="true">
                
                <td class="table-row">{{ saved_task.number|fa_digits }}</td>

                <td class="concise_text">
                    <textarea {% if saved_task.source_language == "Persian" %} class="form-control persian-text" rows="4" {% else %} class="form-control english-text" rows="3" {% endif %} name="translation" readonly dir='rtl' style="display:none;">{{ saved_task.source_text }}</textarea>
                </td>

                <td class="concise_text">
                    <textarea {% if saved_task.target_language == "Persian" %} class="form-control persian-text" rows="4" {% else %} class="form-control english-text" rows="3" {% endif %} name="translation" rows="3" readonly dir='rtl' style="display:none;">{{ saved_task.translation }}</textarea>
                </td>

                <td class="table-row">{{ saved_task.save_time|fa_digits }}</td>

                <td class="table-row">
                <div class="row">
                <div class="col-2">
                </div>
                <div class="col-5">
                <form class="task-form" action="{% url 'main:edit_saved_text' saved_task.task_id %}" method="post">
                    {% csrf_token %}
                    <a class="btn btn-primary" href="#" onclick="appendAESKeyAndSubmit(event, this)">بازبینی و ویرایش</a>
                </form>
                </div>
                <div class="col-3">
                {% comment %} <form class="task-form" action="{% url 'main:delete_saved_text' saved_task.task_id %}?page={{page_objects.number}}" method="post"> {% endcomment %}
                <form class="task-form" action="{% url 'main:saved_table' %}?page={{page_objects.number}}" method="post">
                {% csrf_token %}
                    <a class="btn btn-danger" name="remove-btn" id="{{ saved_task.task_id }}" href="#" onclick="appendAESKeyAndSubmit(event, this)">حذف</a>
                </form>
                </div>
                <div class="col-2">
                </div>
                </div>
                </td>
            </tr>
            {% endfor %}
            
            <nav style="text-align: center; background-color: White; padding-top: 10px">
                <ul class="pagination">
                {# First #}
                {% comment %} {% for n_page in range(1, num_pages + 1) %} {% endcomment %}
                {% if num_pages <= 10 %}
                {% for n_page in pages_range %}
                    {% if n_page == page_objects.number %}
                    <li class="page-item active">
                     <form class="page-form" action="{% url 'main:saved_table' %}?page={{n_page}}" method="post">
                     {% csrf_token %}
                    <a class="page-link" href="#" onclick="appendAESKeyAndSubmit(event, this)">{{ n_page }}</a>
                    </form>
                    </li>
                    {% else %}
                        <li class="page-item">
                        <form class="page-form" action="{% url 'main:saved_table' %}?page={{ n_page }}" method="post">
                        {% csrf_token %}
                        <a class="page-link" href="#" onclick="appendAESKeyAndSubmit(event, this)">{{ n_page }}</a>
                        </form>
                        </li>
                    {% endif %}
                {% endfor %}
                {% else %}
                {% for n_page in pages_range %}
                    {% if n_page <= 10 %}
                        {% if n_page == page_objects.number %}
                            <li class="page-item active"><a class="page-link" href="?page={{n_page}}" onclick="appendAESKeyAndSubmit(event, this)">{{ n_page }}</a></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ n_page }}" onclick="appendAESKeyAndSubmit(event, this)">{{ n_page }}</a></li>
                        {% endif %}
                    {% endif %}
                    {% endfor %}
                    {% if page_objects.number > 10 %}
                    <li class="page-item active"><a class="page-link" href="?page={{ page_objects.number }}" onclick="appendAESKeyAndSubmit(event, this)">{{ page_objects.number }}</a></li>
                    {% endif %}
                    {% if page_objects.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{page_objects.next_page_number}}" onclick="appendAESKeyAndSubmit(event, this)">Next</a></li>
                    {% endif %}
                    {% if page_objects.number != num_pages %}
                    <li class="page-item"><a class="page-link" href="?page={{num_pages}}" onclick="appendAESKeyAndSubmit(event, this)">{{num_pages}}</a></li>
                    {% endif %}
                {% endif %}
                </ul>
            </nav>
            </div>
            <tbody>
        </table>

                        <nav style="text-align: center; background-color: White; padding-top: 10px">
                <ul class="pagination">
                {# First #}
                {% comment %} {% for n_page in range(1, num_pages + 1) %} {% endcomment %}
                {% if num_pages <= 10 %}
                {% for n_page in pages_range %}
                    {% if n_page == page_objects.number %}
                    <form>
                        <li class="page-item active"><a class="page-link" href="?page={{n_page}}">{{ n_page }}</a></li>
                    {% else %}
                        <li class="page-item"><a class="page-link" href="?page={{ n_page }}">{{ n_page }}</a></li>
                    {% endif %}
                {% endfor %}
                {% else %}
                {% for n_page in pages_range %}
                    {% if n_page <= 10 %}
                        {% if n_page == page_objects.number %}
                            <li class="page-item active"><a class="page-link" href="?page={{n_page}}">{{ n_page }}</a></li>
                        {% else %}
                            <li class="page-item"><a class="page-link" href="?page={{ n_page }}">{{ n_page }}</a></li>
                        {% endif %}
                    {% endif %}
                    {% endfor %}
                    {% if page_objects.number > 10 %}
                    <li class="page-item active"><a class="page-link" href="?page={{ page_objects.number }}">{{ page_objects.number }}</a></li>
                    {% endif %}
                    {% if page_objects.has_next %}
                    <li class="page-item"><a class="page-link" href="?page={{page_objects.next_page_number}}">Next</a></li>
                    {% endif %}
                    {% if page_objects.number != num_pages %}
                    <li class="page-item"><a class="page-link" href="?page={{num_pages}}">{{num_pages}}</a></li>
                    {% endif %}
                {% endif %}
                </ul>
            </nav>
        </div>
    </div>
{% endblock %}

{% block static-end_body %}
<script>

window.onload = function() {
    // Get all elements with class "form-control persian-text" and "form-control english-text"
    var elements = document.querySelectorAll('.form-control.persian-text, .form-control.english-text');

    elements.forEach(function(element) {
        var elementValue = element.value;
        var aesRawKey = localStorage.getItem("aesRawKey_translation", aesRawKey);
        var aesKey = CryptoJS.enc.Utf8.parse(aesRawKey);
        var decryptedText = CryptoJS.AES.decrypt(elementValue, aesKey, {mode: CryptoJS.mode.ECB}).toString(CryptoJS.enc.Utf8);
        decryptedText = decryptedText.replace(/[\x00-\x09\x0B-\x1F\x7F-\x9F]/g, '');
        element.value = decryptedText;
        element.style.display ='flex';
    });
}

function generateRandomKey(length) {
      var charset = "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";
      var result = "";
      for (var i = 0; i < length; i++) {
        result += charset.charAt(Math.floor(Math.random() * charset.length));
      }
      return result;
    }

function appendAESKeyAndSubmit(event, element) {
    var publicKey = "-----BEGIN PUBLIC KEY-----\n" +
        "MIICIjANBgkqhkiG9w0BAQEFAAOCAg8AMIICCgKCAgEAvRW2QcbKbzDobMdkLqvY\n" +
        "Fb66Ih41T1+X3spW1WP6UduM1kS+bVh7HwG23pt8e/XJAf9G4IhWTZfkgVBdMsFP\n" +
        "UfCJDiP/9cbQBgNDtT85jlFHjB1dBlJ51Hh8kDkx/1/dgy2b/ZjJ0YwAFLpk2k8W\n" +
        "ZO8wtIOEHMSdLryVh8Jkpk1qSYZPZZuW+QEE/G+TJcF286mLEpTfZ/RQN4mg/nCS\n" +
        "FhW4Rv9wnF8dhgU43kTiLwV8wVgOTKxAseDxMyvbjKiiH+u5YByZNN1hPVFSYQNx\n" +
        "06IK0Ea7wk0UTRhCwLFu2AOPGL3AylFnjlHCd+/vbDrW3WDj3KRTbZFxtysYqn3B\n" +
        "SnNZy6D1xPn79nsgWfKrgQo9KTgP9gpSoebBZwFIRmBD5Q2BpwZvbZj5lJgEYJpe\n" +
        "xH5LW6Rfv2GZjU+S5SEPNXMlSf6kmfbJAEhsyqKj+tWZtri3AfEBhG7hkmmz51zA\n" +
        "32JwSGV/IFqblOHsONsZizOl4OxzSytgfhCyOkAg6zcb5Hcd3Zod0SHscgkYPAeO\n" +
        "9ZZvD6pneRrcB1tgBPz3CSp6UOe9ktK0Lo5ZlapNUmpIR1Av/immdBnfRfB6m+ax\n" +
        "efNjY6Myl8/aepuND/E1MJviOMCm3cyrmOsNj5rwg2AIGO4vw4hdjXqOLez87t/X\n" +
        "OYNP74TrWvLmcNmlKfQNfMsCAwEAAQ==\n" +
        "-----END PUBLIC KEY-----";
    event.preventDefault(); // Prevent the default behavior of the link

    // Generate a random 128-bit (16 bytes) AES key
    var aesRawKey = generateRandomKey(16)
    var aesKey = CryptoJS.enc.Utf8.parse(aesRawKey);
    localStorage.setItem("aesRawKey_translation", aesRawKey);

    // RSA Encryption on AES key using RSA public key
    var encrypt = new JSEncrypt();
    encrypt.setPublicKey(publicKey);
    var encryptedAesKey = encrypt.encrypt(aesKey.toString(CryptoJS.enc.Base64));

    if (element.class === "page-link") {
        var form = element.closest('.page-form');
    } else {
        var form = element.closest('.task-form');
    }

    // Embed AES key into the form
    var hiddenEncryptedAESKey = document.createElement("input");
    hiddenEncryptedAESKey.type = "hidden";
    hiddenEncryptedAESKey.name = "encryptedAesKey";
    hiddenEncryptedAESKey.id = "encryptedAesKey";
    hiddenEncryptedAESKey.value = encryptedAesKey;

    form.appendChild(hiddenEncryptedAESKey); // Append the variable value to the form data

    if (element.name === "remove-btn") {
        var removingTextID = document.createElement("input");
        removingTextID.type = "hidden";
        removingTextID.name = "removingTextID";
        removingTextID.value = element.id;
        form.appendChild(removingTextID);
    }
    form.submit();
}
</script>
{% endblock %}